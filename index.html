<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Widget per Data di Appuntamento</title>
  <!-- Carica jQuery e jQuery UI -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css" />
  
  <!-- Carica la libreria JotForm Custom Widget API -->
  <script src="//js.jotform.com/JotFormCustomWidget.js"></script>

  <style>
    /* Stili per distinguere giorni disponibili e non disponibili */
    .available-day a {
      background-color: #DFF0D8 !important;
      color: #3C763D !important;
    }
    .unavailable-day a {
      background-color: #F2DEDE !important;
      color: #A94442 !important;
    }
    /* Stili di base */
    #main {
      padding: 10px;
      font-family: Arial, sans-serif;
    }
    #header {
      margin-bottom: 10px;
    }
  </style>

</head>
<body>

  <div id="main">
    <h3 id="header">huhuhu</h3>
    <div id="casocaso"></div>
    <!-- Qui verrà visualizzato il Datepicker -->
    <div id="datepicker"></div>
    
  </div>

  <script type="text/javascript">
    function isSameDate(date1, date2) {
      return date1.getFullYear() === date2.getFullYear() &&
             date1.getMonth() === date2.getMonth() &&
             date1.getDate() === date2.getDate();
    }
    

    // Sottoscrizione all'evento "ready" fornito dall'API di JotForm
    JFCustomWidget.subscribe("ready", function(formId, value) {
      // Imposta il titolo: utilizza il parametro "QuestionLabel" se disponibile, altrimenti usa il valore predefinito
      let label = JFCustomWidget.getWidgetSetting('QuestionLabel') || 'Seleziona una data per l\'appuntamento';
      document.getElementById('header').innerHTML = label;

      JFCustomWidget.requestFrameResize({ height: 1200 });



      // Recupera il parametro "AllowedDates" (atteso come stringa separata da virgole, nel formato yyyy-mm-dd)
      let allowedDatesSetting = JFCustomWidget.getWidgetSetting('AllowedDates');
      let allowedDates = allowedDatesSetting ? allowedDatesSetting.split(',').map(dateStr => new Date(dateStr.trim())) : [];
      
      // Inizializza il Datepicker di jQuery UI con il formato dd/mm/yy
      $("#datepicker").datepicker({
        dateFormat: 'dd/mm/yy',
        beforeShowDay: function(date) {
          // Verifica se la data corrente è tra quelle consentite
          let allowedTrasform = new Date(allowedDatesSetting);
          let allowed = isSameDate(date, allowedTrasform);

          if (allowed) {
            return [true, "available-day", "Disponibile"];
          }
          return [false, "unavailable-day", "Non disponibile"];
        },
        onSelect: function(dateText, inst) {
          console.log("Data selezionata: " + dateText);
        }
      });

      // Se esiste un valore pre-esistente (ad esempio, in fase di modifica), lo pre-seleziona
      if (value) {
        try {
          var preselectedDate = $.datepicker.parseDate('dd/mm/yy', value);
          $("#datepicker").datepicker("setDate", preselectedDate);
        } catch (e) {
          console.warn("Impossibile analizzare la data pre-selezionata:", value);
        }
      }

      // (Opzionale) Ridimensiona l'iframe se necessario
      JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight });
    });

    // Sottoscrizione all'evento "submit" per inviare il valore selezionato a JotForm
    JFCustomWidget.subscribe("submit", function() {
      var selectedDate = $("#datepicker").datepicker("getDate");
      if (!selectedDate) {
        JFCustomWidget.sendSubmit({ valid: false, value: "" });
      } else {
        var formattedDate = $.datepicker.formatDate('dd/mm/yy', selectedDate);
        JFCustomWidget.sendSubmit({ valid: true, value: formattedDate });
      }
    });
  </script>

</body>
</html>