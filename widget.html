<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Appointment Date Widget</title>
  <!-- Load jQuery and jQuery UI (ensure these libraries are available) -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.1/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.1/themes/base/jquery-ui.css" />
  
  <!-- Load the JotForm Custom Widget API (will only load if used inside JotForm) -->
  <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
  
  <style>
    /* Optional styling to visually differentiate available/unavailable dates */
    .available-day a {
      background-color: #DFF0D8 !important;
      color: #3C763D !important;
    }
    .unavailable-day a {
      background-color: #F2DEDE !important;
      color: #A94442 !important;
    }
    /* Basic layout styling */
    #main {
      padding: 10px;
      font-family: Arial, sans-serif;
    }
    #header {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div id="main">
    <h3 id="header">Select an Appointment Date</h3>
    <!-- The datepicker will be rendered here -->
    <div id="datepicker"></div>
  </div>
  
  <script type="text/javascript">
    // Helper function: Compare two Date objects (ignoring time)
    function isSameDate(date1, date2) {
      return date1.getFullYear() === date2.getFullYear() &&
             date1.getMonth() === date2.getMonth() &&
             date1.getDate() === date2.getDate();
    }

    // The main initialization function for our widget.
    // 'value' is the previously selected date (if any), as passed by the JotForm API.
    function initializeWidget(value) {
      // Use widget setting 'QuestionLabel' if available, otherwise use a default title.
      var label = 'Select an Appointment Date';
      if (window.JFCustomWidget && typeof JFCustomWidget.getWidgetSetting === "function") {
        label = JFCustomWidget.getWidgetSetting('QuestionLabel') || label;
      }
      document.getElementById('header').innerHTML = label;
      
      // Read the AllowedDates setting (expected as a comma-separated list of dates)
      var allowedDatesParam = null;
      if (window.JFCustomWidget && typeof JFCustomWidget.getWidgetSetting === "function") {
        allowedDatesParam = JFCustomWidget.getWidgetSetting('AllowedDates');
      }
      
      var allowedDates = [];
      if (allowedDatesParam) {
        allowedDates = allowedDatesParam.split(',').map(function(dateStr) {
          dateStr = dateStr.trim();
          var parsedDate;
          try {
            // Try parsing with format mm/dd/yy
            parsedDate = $.datepicker.parseDate('mm/dd/yy', dateStr);
          } catch (e) {
            try {
              // If that fails, try mm/dd/yyyy
              parsedDate = $.datepicker.parseDate('mm/dd/yyyy', dateStr);
            } catch (e2) {
              parsedDate = null;
            }
          }
          return parsedDate;
        }).filter(function(d) { return d !== null; });
      }
      
      // If no valid allowed dates are provided, use a default set.
      if (!allowedDates.length) {
        allowedDates = [
          new Date(2025, 2, 3),   // March 3, 2025 (months are zero-indexed)
          new Date(2025, 2, 10),  // March 10, 2025
          new Date(2025, 2, 15)   // March 15, 2025
        ];
      }
      
      // Initialize the jQuery UI Datepicker.
      $("#datepicker").datepicker({
        dateFormat: 'mm/dd/yy',
        beforeShowDay: function(date) {
          // Enable only if this date is in the allowedDates array.
          var allowed = allowedDates.some(function(allowedDate) {
            return isSameDate(date, allowedDate);
          });
          if (allowed) {
            return [true, "available-day", "Available"];
          }
          return [false, "unavailable-day", "Unavailable"];
        },
        onSelect: function(dateText, inst) {
          console.log("Date selected: " + dateText);
        }
      });
      
      // If a previously selected date exists (e.g., when editing a submission), preselect it.
      if (value) {
        try {
          var preselectedDate = $.datepicker.parseDate('mm/dd/yy', value);
          $("#datepicker").datepicker("setDate", preselectedDate);
        } catch (e) {
          console.warn("Could not parse the preselected date:", value);
        }
      }
      
      // (Optional) Resize the widget's iframe if needed.
      if (window.JFCustomWidget && typeof JFCustomWidget.requestFrameResize === "function") {
        JFCustomWidget.requestFrameResize({ height: document.body.scrollHeight });
      }
    }
    
    // If the JotForm widget API is available, use it; otherwise, fall back to standalone initialization.
    if (window.JFCustomWidget && typeof JFCustomWidget.subscribe === "function") {
      JFCustomWidget.subscribe("ready", function(formId, value) {
        initializeWidget(value);
      });
      
      JFCustomWidget.subscribe("submit", function() {
        var selectedDate = $("#datepicker").datepicker("getDate");
        if (!selectedDate) {
          JFCustomWidget.sendSubmit({ valid: false, value: "" });
        } else {
          var formattedDate = $.datepicker.formatDate('mm/dd/yy', selectedDate);
          JFCustomWidget.sendSubmit({ valid: true, value: formattedDate });
        }
      });
    } else {
      // Standalone testing fallback: initialize when the document is ready.
      $(document).ready(function(){
        initializeWidget("");
      });
    }
  </script>
</body>
</html>

